<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jornada de Contratação - Guarddrone</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Custom Styles -->
    <style>
        /* ==========================================================================
           1. ESTILOS GLOBAIS E VARIÁVEIS DE DESIGN (DESIGN TOKENS)
           ========================================================================== */
        :root {
            --color-red: #DA291C;
            --color-blue: #117AAC;
            --color-green: #2ECC71;
            --color-bg-dark: #0A1014;
            --color-bg-surface: #0D161C;
            --color-border: #2A3F4D;
            --color-text-primary: #FFFFFF;
            --color-text-secondary: #A0B3C1;
        }

        html { scroll-behavior: smooth; }
        body {
            background-color: var(--color-bg-dark);
            color: var(--color-text-primary);
            font-family: 'Inter', sans-serif; /* FONTE ATUALIZADA */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ==========================================================================
           2. CLASSES DE UTILIDADE CUSTOMIZADAS
           ========================================================================== */
        .font-brand-logo { font-family: 'Montserrat', sans-serif; font-weight: 900; letter-spacing: 0.05em; text-transform: uppercase; } /* FONTE ORIGINAL DO LOGOTIPO */
        .font-title { font-family: 'Space Grotesk', sans-serif; font-weight: 700; } /* FONTE ATUALIZADA */

        .text-brand-red { color: var(--color-red); }
        .bg-brand-red { background-color: var(--color-red); }
        .text-brand-blue { color: var(--color-blue); }
        .bg-brand-blue { background-color: var(--color-blue); }
        .bg-brand-green { background-color: var(--color-green); }
        .text-brand-green { color: var(--color-green); }
        .bg-surface { background-color: var(--color-bg-surface); }
        .border-brand { border-color: var(--color-border); }

        .hidden-on-load { opacity: 0; }
        .hidden { display: none; }

        #contractSection, #confirmationSection { display: none; }

        /* ==========================================================================
           3. ESTILOS DE COMPONENTES
           ========================================================================== */

        /* --- Botões --- */
        .cta-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .cta-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 7px 25px rgba(46, 204, 113, 0.4);
        }
        .cta-button:disabled {
            cursor: not-allowed;
            background-color: #555;
            opacity: 0.7;
        }

        /* --- Formulários --- */
        .form-group { position: relative; }
        .form-input, .form-select {
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            width: 100%;
            padding: 1.25rem 1rem 0.5rem;
            border-radius: 0.375rem;
            transition: border-color 0.3s ease;
            appearance: none;
        }
        .form-label {
            position: absolute;
            top: 0.9rem;
            left: 1rem;
            color: var(--color-text-secondary);
            pointer-events: none;
            transition: all 0.2s ease-out;
        }
        .form-input:focus, .form-select:focus,
        .form-input:not(:placeholder-shown) {
            outline: none;
            border-color: var(--color-blue);
        }
        .form-input:focus + .form-label,
        .form-input:not(:placeholder-shown) + .form-label,
        .form-input:valid + .form-label,
        .form-label.active-label {
            top: 0.25rem;
            font-size: 0.75rem;
            color: var(--color-blue);
        }
        .form-input.invalid { border-color: var(--color-red) !important; }
        .feedback-icon {
            position: absolute;
            top: 50%; right: 1rem;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .feedback-icon.visible { opacity: 1; }

        /* --- Contrato --- */
        .contract-clause h4 {
            font-family: 'Space Grotesk', sans-serif; /* FONTE ATUALIZADA */
            font-weight: 700;
            color: var(--color-blue);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .contract-clause p, .contract-clause li {
            color: var(--color-text-secondary);
            line-height: 1.6;
            font-size: 0.875rem;
        }

        /* ==========================================================================
           4. ANIMAÇÕES E EFEITOS ESPECIAIS
           ========================================================================== */

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .fade-in-delay-1 { animation-delay: 0.2s; }
        .fade-in-delay-2 { animation-delay: 0.4s; }
        .fade-in-delay-3 { animation-delay: 0.6s; }

        @keyframes scale-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes slide-and-fade-in {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulsing-glow {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        .animate-scale-in { animation: scale-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-slide-in { opacity: 0; animation: slide-and-fade-in 0.8s ease-out forwards; }
        .confirmation-icon-wrapper { animation: pulsing-glow 2s infinite 1s; border-radius: 50%; }

        #hero-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
    </style>
</head>
<body class="antialiased">

    <div class="relative overflow-hidden">
        <canvas id="hero-canvas"></canvas>
        <div class="relative z-10 container mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-20 max-w-5xl">

            <!-- ==========================================================================
               CABEÇALHO
               ========================================================================== -->
            <header class="text-center mb-16 hidden-on-load fade-in">
                <a href="index.html" class="inline-block bg-brand-red px-8 py-3 mb-2 shadow-lg">
                    <h1 class="font-brand-logo text-2xl md:text-3xl text-white">GUARDDRONE</h1>
                </a>
                <h2 class="font-title text-3xl text-white mt-4">Jornada de Contratação</h2>
            </header>

            <!-- ==========================================================================
               INDICADOR DE ETAPA
               ========================================================================== -->
            <div id="stepIndicator" class="flex justify-between items-center max-w-lg mx-auto mb-12 hidden-on-load fade-in-delay-1">
                <!-- Etapa 1: Dados -->
                <div id="step1" class="step-item text-center">
                    <div class="step-circle bg-brand-red text-white w-10 h-10 rounded-full flex items-center justify-center font-bold mx-auto transition-all duration-300">1</div>
                    <p class="text-sm mt-2 transition-colors duration-300">Seus Dados</p>
                </div>
                <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
                <!-- Etapa 2: Contrato -->
                <div id="step2" class="step-item text-center opacity-50">
                    <div class="step-circle bg-gray-700 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold mx-auto transition-all duration-300">2</div>
                    <p class="text-sm mt-2 transition-colors duration-300">Contrato</p>
                </div>
                <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
                <!-- Etapa 3: Confirmação -->
                <div id="step3" class="step-item text-center opacity-50">
                    <div class="step-circle bg-gray-700 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold mx-auto transition-all duration-300">3</div>
                    <p class="text-sm mt-2 transition-colors duration-300">Confirmação</p>
                </div>
            </div>

            <!-- ==========================================================================
               FLUXO PRINCIPAL DO FORMULÁRIO E ONBOARDING
               ========================================================================== -->
            <form id="onboardingForm" action="https://formspree.io/f/mqabbqkj" method="POST">
                <!-- Campos ocultos para enviar dados do plano e contrato -->
                <input type="hidden" name="plano-selecionado" id="hidden_selected_plan">
                <input type="hidden" name="valor-mensal" id="hidden_monthly_value">
                <input type="hidden" name="codigo-contrato" id="hidden_contract_code">

                <main id="onboardingFlow" class="bg-surface border border-brand rounded-lg shadow-2xl p-6 sm:p-8 md:p-12 hidden-on-load fade-in-delay-2">

                    <!-- ETAPA 1: COLETA DE DADOS -->
                    <section id="dataCollectionSection">
                         <div class="text-center">
                            <h3 class="font-title text-2xl text-white mb-2">Formulário de Ativação</h3>
                            <p class="text-gray-400 mb-2">Plano Selecionado: <strong id="display-selected-plan" class="text-brand-red"></strong></p>
                            <p class="text-gray-400 mb-8">Precisamos das suas informações para gerar o contrato e configurar a proteção.</p>
                         </div>
                         <div class="space-y-6 max-w-2xl mx-auto">
                            <!-- Dados Pessoais -->
                            <div class="form-group">
                                <input type="text" id="fullName" name="nome-completo" class="form-input" placeholder=" " required>
                                <label for="fullName" class="form-label">Nome Completo</label>
                                <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                            </div>
                            <div class="form-group">
                                <input type="tel" id="cpf" name="cpf" class="form-input" placeholder=" " required>
                                <label for="cpf" class="form-label">CPF</label>
                                <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                            </div>
                            <div class="form-group">
                                <input type="email" id="email" name="email" class="form-input" placeholder=" " required>
                                <label for="email" class="form-label">E-mail Principal</label>
                                <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                            </div>

                            <hr class="border-gray-700">
                            <!-- Contato para Alertas -->
                            <h4 class="font-title text-lg text-brand-blue">Contatos para Alertas</h4>
                            <div class="form-group">
                                <input type="tel" id="whatsapp1" name="telefone-contato" class="form-input" placeholder=" " required>
                                <label for="whatsapp1" class="form-label">Telefone Principal com WhatsApp</label>
                                <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                            </div>

                            <hr class="border-gray-700">
                            <!-- Endereço do Imóvel -->
                            <h4 class="font-title text-lg text-brand-blue">Endereço do Imóvel a ser Monitorado</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group">
                                    <input type="tel" id="zipcode" name="cep" class="form-input" placeholder=" " required>
                                    <label for="zipcode" class="form-label">CEP</label>
                                    <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                                </div>
                                <div class="md:col-span-2 form-group">
                                    <input type="text" id="street" name="rua" class="form-input" placeholder=" " required>
                                    <label for="street" class="form-label">Rua / Avenida</label>
                                    <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <input type="text" id="number" name="numero" class="form-input" placeholder=" " required>
                                    <label for="number" class="form-label">Número</label>
                                    <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="neighborhood" name="bairro" class="form-input" placeholder=" " required>
                                    <label for="neighborhood" class="form-label">Bairro</label>
                                    <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <input type="text" id="city" name="cidade" class="form-input" placeholder=" " required>
                                    <label for="city" class="form-label">Cidade</label>
                                    <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="state" name="estado-uf" class="form-input" placeholder=" " required>
                                    <label for="state" class="form-label">Estado</label>
                                    <span class="feedback-icon"><i class="fas fa-check-circle text-brand-green"></i></span>
                                </div>
                            </div>
                         </div>
                         <div class="text-center mt-10">
                             <button type="button" id="toContractBtn" class="cta-button w-full md:w-auto bg-brand-green text-white font-bold py-4 px-10 rounded-lg text-lg">
                                 Rever Contrato e Finalizar
                             </button>
                         </div>
                    </section>

                    <!-- ETAPA 2: REVISÃO DO CONTRATO -->
                    <section id="contractSection">
                        <div class="text-center">
                            <h3 class="font-title text-2xl text-white mb-2">Contrato de Prestação de Serviços</h3>
                            <p class="text-gray-400 mb-8">Por favor, reveja os termos do contrato gerado com as suas informações.</p>
                        </div>
                        <div id="contractText" class="bg-gray-900/50 p-6 rounded-lg max-h-96 overflow-y-auto border border-brand space-y-4">
                            <!-- Cláusulas do contrato são inseridas aqui -->
                            <div class="contract-clause">
                                <h4>CONTRATO DE PRESTAÇÃO DE SERVIÇOS DE MONITORAMENTO AÉREO REMOTO</h4>
                            </div>
                            <div class="contract-clause">
                                <h4>DAS PARTES CONTRATANTES</h4>
                                <p>Pelo presente instrumento particular, de um lado:</p>
                                <p><strong>CONTRATADA:</strong> GUARDDRONE TECNOLOGIA EM SEGURANÇA LTDA., pessoa jurídica de direito privado, inscrita no CNPJ sob o nº 52.970.673/0001-78, com sede na Rua Curitibanos, n° 1620, Bairro Boa Vista, Canoinhas, SC, CEP 89.460-000.</p>
                                <p>De outro lado:</p>
                                <p><strong>CONTRATANTE:</strong> <span id="contract_fullName" class="text-white font-bold"></span>, inscrito(a) no CPF sob o n° <span id="contract_cpf" class="text-white font-bold"></span>, residente e domiciliado(a) no endereço do imóvel a ser monitorado, qual seja, <span id="contract_address" class="text-white font-bold"></span>.</p>
                                <p>As partes acima qualificadas e doravante denominadas, respectivamente, CONTRATADA e CONTRATANTE, têm entre si, justo e contratado o presente instrumento particular de Prestação de Serviços de Monitoramento Aéreo Remoto, que se regerá pelas cláusulas e condições seguintes:</p>
                            </div>
                             <div class="contract-clause">
                                <h4>CÓDIGO DE IDENTIFICAÇÃO DO CONTRATO</h4>
                                <p><strong>Código de Identificação:</strong> <span id="contract_code_display" class="text-white font-bold"></span></p>
                            </div>
                             <div class="contract-clause">
                                <h4>DO PLANO CONTRATADO</h4>
                                <p><strong>Plano de Serviço Selecionado:</strong> <span id="contract_plan" class="text-white font-bold"></span> Valor Mensal: <span id="contract_value_extensive_plan" class="text-white font-bold"></span> (R$ <span id="contract_value_numeric_plan" class="text-white font-bold"></span>) Modalidade de Contrato: <span id="contract_loyalty" class="text-white font-bold"></span></p>
                            </div>
                            <div class="contract-clause">
                                <h4>CLÁUSULA PRIMEIRA - DO OBJETO DO CONTRATO</h4>
                                <p>1.1. O presente Contrato tem como objeto a prestação de serviços de monitoramento aéreo noturno preventivo e dissuasório, a ser realizado pela CONTRATADA, por meio de Rondas Ostensivas com Drones (Aeronaves Remotamente Pilotadas - RPAs), no perímetro do imóvel da CONTRATANTE, situado no endereço supracitado.</p>
                                <p>1.2. Os serviços descritos no item anterior incluem as seguintes atividades: a) Realização de até 3 (três) sobrevoos programados por noite, em horários variáveis durante o período da madrugada, sobre o imóvel da CONTRATANTE. b) Captura de imagens e/ou vídeos em caso de detecção de atividade atípica ou suspeita nos limites da propriedade monitorada. c) Envio de alertas em tempo real para o(s) número(s) de WhatsApp cadastrado(s) pela CONTRATANTE, contendo a imagem aérea e a geolocalização da ocorrência. d) Possibilidade de acionamento remoto das autoridades policiais competentes, a exclusivo critério da CONTRATADA, caso a análise da ocorrência indique risco iminente ou flagrante delito.</p>
                                <p>1.3. Do Serviço Adicional "Sobrevoo Agora": O serviço "Sobrevoo Agora", que possibilita à CONTRATANTE solicitar um sobrevoo não programado mediante requisição específica via canal de atendimento, constitui um serviço opcional e será cobrado à parte, estando sujeito à disponibilidade operacional da CONTRATADA e às condições climáticas. Este serviço é exclusivo para CONTRATANTES que possuam um contrato de monitoramento ativo com a CONTRATADA. Os valores e condições para a contratação do serviço "Sobrevoo Agora" serão informados separadamente no momento da solicitação.</p>
                                <p class="font-bold text-brand-red mt-2">1.4. Fica expressamente estabelecido que o presente serviço possui caráter de meio, e não de resultado. A CONTRATADA empregará a melhor técnica, diligência e recursos disponíveis para a execução do monitoramento, contudo, NÃO SE RESPONSABILIZA E NÃO OFERECE GARANTIA contra a ocorrência de furtos, roubos, invasões, danos ao patrimônio ou quaisquer outros delitos no imóvel da CONTRATANTE.</p>
                            </div>
                            <div class="contract-clause">
                                <h4>CLÁUSULA SEGUNDA - DAS OBRIGAÇÕES DA CONTRATADA</h4>
                                <p>2.1. Prestar os serviços delineados na Cláusula Primeira com o máximo de zelo, profissionalismo e em estrita conformidade com as normas e regulamentações vigentes da Agência Nacional de Aviação Civil (ANAC) e do Departamento de Controle do Espaço Aéreo (DECEA), bem como seguir as melhores práticas internacionais do setor e as diretrizes de sistemas de gestão da qualidade, a exemplo da NBR ISO 9001.</p>
                                <p>2.2. Manter seus equipamentos (drones, baterias, sistemas de comunicação e monitoramento) em perfeitas condições de funcionamento, segurança e aptidão para o uso.</p>
                                <p>2.3. Dispor de pilotos devidamente habilitados, licenciados e treinados para a supervisão e operação das Aeronaves Remotamente Pilotadas (RPAs).</p>
                                <p>2.4. Manter sigilo absoluto sobre todas as informações pessoais da CONTRATANTE e sobre as imagens e dados capturados durante os sobrevoos, utilizando-os estritamente para os fins de segurança e monitoramento previstos neste contrato, e em conformidade com a legislação aplicável.</p>
                                <p>2.5. Comunicar previamente à CONTRATANTE sobre eventuais interrupções programadas do serviço para fins de manutenção, atualizações de sistema ou por qualquer outra necessidade operacional, sempre que possível, com antecedência razoável.</p>
                            </div>
                             <div class="contract-clause">
                                <h4>CLÁUSULA TERCEIRA - DAS OBRIGAÇÕES DA CONTRATANTE</h4>
                                <p>3.1. Efetuar o pagamento pontual do valor mensal estipulado neste contrato, conforme as condições estabelecidas na Cláusula Quinta.</p>
                                 <p>3.2. Fornecer e manter atualizados todos os seus dados cadastrais, incluindo, mas não se limitando a, nome completo, CPF, endereço completo, e-mail e, primordialmente, o(s) número(s) de telefone com acesso ao WhatsApp para o recebimento dos alertas. A desatualização desses dados pode comprometer a eficácia do serviço.</p>
                                 <p>3.3. Informar prontamente à CONTRATADA sobre quaisquer particularidades, riscos conhecidos, obras ou alterações estruturais relevantes no imóvel que possam, de alguma forma, afetar a segurança, a operacionalidade ou a eficácia dos sobrevoos e do monitoramento.</p>
                                 <p>3.4. Utilizar os serviços e as informações recebidas (especialmente os alertas) de forma prudente e responsável, sendo de sua inteira responsabilidade as ações ou omissões tomadas em decorrência de um alerta. A CONTRATADA recomenda expressamente que a CONTRATANTE, ao receber um alerta de situação suspeita, não se exponha a riscos e aguarde a chegada das autoridades competentes, caso estas tenham sido acionadas ou sejam pertinentes.</p>
                            </div>
                            <div class="contract-clause">
                                <h4>CLÁUSULA QUARTA - DA LIMITAÇÃO DE RESPONSABILIDADE</h4>
                                <p>4.1. O serviço de monitoramento poderá ser temporariamente afetado ou interrompido por condições climáticas adversas (tais como chuvas fortes, ventanias, neblina densa), falhas na comunicação do sinal de GPS, problemas de conexão com a operadora de telefonia ou internet, indisponibilidade de energia elétrica no local do imóvel ou por outras condições de caso fortuito ou força maior, alheias ao controle da CONTRATADA. Nestas hipóteses, a CONTRATADA fica isenta de qualquer responsabilidade pela não realização das rondas.</p>
                                <p>4.2. A CONTRATADA não se responsabiliza por eventuais falhas no recebimento dos alertas pela CONTRATANTE que sejam decorrentes de problemas no aparelho celular da CONTRATANTE, ausência de conexão com a internet (Wi-Fi ou dados móveis), aplicativo de mensagens desatualizado, número de telefone incorreto ou qualquer outra questão técnica que seja de responsabilidade exclusiva da CONTRATANTE.</p>
                                <p>4.3. O acionamento das autoridades policiais pela CONTRATADA é um ato discricionário, baseado em sua análise técnica da situação, e visa colaborar com a segurança pública. A CONTRATADA não se responsabiliza pelo tempo de resposta, pela atuação ou pela eventual não atuação das forças policiais, nem pelos resultados de suas intervenções.</p>
                                <p>4.4. A responsabilidade civil da CONTRATADA por eventuais danos diretos comprovadamente causados por falha na prestação do serviço objeto deste contrato fica limitada, em qualquer hipótese, ao valor equivalente a 3 (três) mensalidades vigentes à época do evento danoso.</p>
                            </div>
                            <div class="contract-clause">
                                <h4>CLÁUSULA QUINTA - DO PREÇO E DAS CONDIÇÕES DE PAGAMENTO</h4>
                                <p>5.1. Pela prestação dos serviços objeto deste contrato, a CONTRATANTE pagará à CONTRATADA o valor mensal de <span id="contract_value_extensive" class="text-white font-bold"></span> (R$ <span id="contract_value_numeric" class="text-white font-bold"></span>), conforme o plano de serviço selecionado.</p>
                                <p>5.2. O pagamento deverá ser efetuado até o dia <span id="contract_paymentDay" class="text-white font-bold"></span> de cada mês, através de boleto bancário, PIX ou outro meio eletrônico de pagamento disponibilizado pela CONTRATADA.</p>
                                <p>5.3. O não pagamento na data de vencimento sujeitará a CONTRATANTE ao pagamento de multa de 2% (dois por cento) sobre o valor devido, acrescido de juros de mora de 1% (um por cento) ao mês e correção monetária pelo Índice Geral de Preços do Mercado (IGPM/FGV) ou outro indice que venha a substituí-lo.</p>
                                <p>5.4. O atraso no pagamento por um período superior a 15 (quinze) dias corridos poderá acarretar a suspensão imediata dos serviços, independentemente de notificação prévia. O atraso superior a 30 (trinta) dias corridos poderá ocasionar o cancelamento do presente contrato por justa causa, sem prejuízo da cobrança dos valores em aberto, da multa por rescisão, se aplicável, e das medidas legais cabíveis.</p>
                            </div>
                            <div class="contract-clause">
                                <h4>CLÁUSULA SEXTA - DA VIGÊNCIA E DA RESCISÃO</h4>
                                <p>6.1. O presente contrato inicia-se na data de sua assinatura, em <span id="contract_signature_date_short" class="text-white font-bold"></span>.</p>
                                <p>6.2. Da Rescisão pela CONTRATADA: A CONTRATADA poderá rescindir o presente contrato a qualquer momento, por sua livre e exclusiva conveniência, mediante comunicação formal à CONTRATANTE com antecedência mínima de 30 (trinta) dias. Nesta hipótese, a CONTRATADA estará isenta de qualquer ônus ou multa rescisória, exceto a obrigação de prestar os serviços até o final do período do aviso prévio, caso a CONTRATANTE já tenha efetuado o pagamento correspondente.</p>
                                <p>6.3. Da Rescisão pela CONTRATANTE: </p>
                                <ul id="loyaltyClause" class="list-disc list-inside ml-4 space-y-2">
                                  <!-- O conteúdo da cláusula de fidelidade será inserido dinamicamente aqui pelo JS -->
                                </ul>
                                <p>6.4. O presente contrato poderá ser rescindido de pleno direito por qualquer uma das partes em caso de descumprimento de qualquer de suas cláusulas ou condições, mediante notificação formal à parte infratora para que sane a falta no prazo improrrogável de até 10 (dez) dias corridos. Persistindo a falha após o referido prazo, o contrato será considerado rescindido, sujeitando a parte culpada às penalidades cabíveis e às indenizações por perdas e danos, conforme o caso.</p>
                            </div>
                            <div class="contract-clause">
                                <h4>CLÁUSULA SÉTIMA - DA PROTEÇÃO DE DADOS (LGPD)</h4>
                                <p>7.1. A CONTRATANTE, ao aceitar os termos deste contrato, AUTORIZA EXPRESSAMENTE a CONTRATADA a realizar sobrevoos e a capturar imagens e vídeos do perímetro de seu imóvel para os fins exclusivos de segurança e monitoramento, conforme detalhado neste instrumento.</p>
                                <p>7.2. A CONTRATADA compromete-se a adotar todas as medidas técnicas e administrativas aptas a proteger os dados pessoais e as imagens coletadas contra acessos não autorizados e de situações acidentais ou ilícitas de destruição, perda, alteração, comunicação ou qualquer forma de tratamento inadequado ou ilícito, nos exatos termos da Lei nº 13.709/2018 (Lei Geral de Proteção de Dados Pessoais - LGPD) e em alinhamento com os padrões da norma NBR ISO/IEC 27001 para segurança da informação.</p>
                                <p>7.3. As imagens capturadas serão armazenadas em ambiente seguro pelo prazo estritamente necessário para o cumprimento das finalidades do contrato ou para o cumprimento de obrigação legal ou regulatória, sendo descartadas de forma segura e irrecoverável após o transcurso deste período.</p>
                            </div>
                             <div class="contract-clause">
                                <h4>CLÁUSULA OITAVA - DO FORO</h4>
                                <p>8.1. Para dirimir quaisquer controvérsias, dúvidas ou litígios oriundos do presente contrato, as partes elegem o foro da Comarca de Canoinhas, Estado de Santa Catarina, com expressa renúncia a qualquer outro, por mais privilegiado que seja.</p>
                            </div>
                            <div class="contract-clause">
                                <p class="text-gray-300">E, por estarem assim justas e contratadas, as partes assinam o presente instrumento em 2 (duas) vias de igual teor e forma, na presença das testemunhas abaixo.</p>
                                <p class="text-gray-300">Canoinhas, <span id="contract_signature_date_extensive" class="text-white font-bold"></span>.</p>
                                <p class="text-gray-300"><span id="contract_signature_client_name" class="text-white font-bold"></span> CONTRATANTE</p>
                                <p class="text-gray-300">GUARDDRONE TECNOLOGIA EM SEGURANÇA LTDA. CONTRATADA</p>
                            </div>
                        </div>
                        <div class="mt-8 space-y-6">
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" id="termsCheckbox" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-brand-red focus:ring-brand-red">
                                <span class="ml-3 text-gray-300">Declaro que li e estou de acordo com todos os termos do Contrato.</span>
                            </label>
                            <div class="text-center">
                                <button type="submit" id="finalAcceptBtn" class="cta-button w-full md:w-auto bg-brand-green text-white font-bold py-4 px-10 rounded-lg text-lg" disabled>
                                    Confirmar Contratação
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- ETAPA 3: CONFIRMAÇÃO -->
                    <section id="confirmationSection">
                        <div class="text-center">
                            <div id="confirmationIconWrapper" class="inline-block mb-6">
                                <i id="confirmationIcon" class="fas fa-check-circle text-brand-green text-6xl"></i>
                            </div>
                            <h3 id="confirmationTitle" class="font-title text-3xl text-white mb-4">Contratação Concluída com Sucesso!</h3>
                            <p id="confirmationMessage" class="text-text-secondary text-lg max-w-2xl mx-auto mb-8">
                                Obrigado por escolher a Guarddrone para a sua segurança. Sua proteção já está sendo preparada. Baixe uma cópia do seu contrato abaixo.
                            </p>

                            <div id="confirmationSummary" class="bg-gray-900/50 p-6 rounded-lg border border-brand text-left max-w-xl mx-auto space-y-3">
                                <h4 class="font-title text-xl text-brand-blue mb-4 text-center">Resumo da Contratação</h4>
                                <p><strong>Código do Contrato:</strong> <span id="confirm_contractCode" class="text-white font-mono"></span></p>
                                <hr class="border-gray-700">
                                <p><strong>Nome:</strong> <span id="confirm_fullName" class="text-white"></span></p>
                                <p><strong>CPF:</strong> <span id="confirm_cpf" class="text-white"></span></p>
                                <p><strong>Email:</strong> <span id="confirm_email" class="text-white"></span></p>
                                <p><strong>Telefone para Contato:</strong> <span id="confirm_whatsapp" class="text-white"></span></p>
                                <p><strong>Endereço Completo:</strong> <span id="confirm_address" class="text-white"></span></p>
                                <hr class="border-gray-700">
                                <p><strong>Plano Contratado:</strong> <span id="confirm_plan_details" class="text-brand-red font-bold"></span></p>
                                <p><strong>Fidelidade:</strong> <span id="confirm_loyalty_details" class="text-white"></span></p>
                            </div>

                            <div id="confirmationButtons" class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-4">
                                <button type="button" id="downloadPdfBtn" class="cta-button w-full sm:w-auto bg-brand-red text-white font-bold py-3 px-8 rounded-lg text-lg flex items-center justify-center gap-2">
                                    <i class="fas fa-file-pdf"></i> Baixar Contrato em PDF
                                </button>
                                <a href="index.html" class="cta-button w-full sm:w-auto bg-brand-blue text-white font-bold py-3 px-8 rounded-lg text-lg">
                                    Voltar à Página Inicial
                                </a>
                            </div>
                        </div>
                    </section>
                </main>
            </form>
        </div>
    </div>

    <!-- ==========================================================================
       JAVASCRIPT
       ========================================================================== -->
    <script type="module">
        // Importa jsPDF globalmente, garantindo que esteja disponível
        const { jsPDF } = window.jspdf;

        /**
         * @module Utils
         * @description Módulo de funções utilitárias compartilhadas.
         */
        const Utils = {
            maskPhone(value) {
                return value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').substring(0, 15);
            },
            maskCep(value) {
                return value.replace(/\D/g, '').replace(/(\d{5})(\d)/, '$1-$2').substring(0, 9);
            },
            maskCpf(value) {
                return value.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').substring(0, 14);
            },
            validateInput(input) {
                let isValid = false;
                const value = input.value;
                switch (input.type) {
                    case 'email': isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value); break;
                    case 'tel':
                        if (input.id === 'whatsapp1') isValid = value.replace(/\D/g, '').length >= 10;
                        else if (input.id === 'zipcode') isValid = value.replace(/\D/g, '').length === 8;
                        else if (input.id === 'cpf') isValid = value.replace(/\D/g, '').length === 11;
                        else isValid = value.trim() !== '';
                        break;
                    default: isValid = value.trim() !== ''; break;
                }
                const label = input.parentElement.querySelector('.form-label');
                if (label) label.classList.toggle('active-label', value.trim() !== '');
                const feedbackIcon = input.parentElement.querySelector('.feedback-icon');
                if (feedbackIcon) {
                    feedbackIcon.classList.toggle('visible', isValid);
                    feedbackIcon.innerHTML = isValid ? '<i class="fas fa-check-circle text-brand-green"></i>' : '';
                }
                input.classList.toggle('invalid', !isValid && value.trim() !== '');
                return isValid;
            },
            setupCanvasAnimation(canvas, particleColor = 'rgba(218, 41, 28, {opacity})') {
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let particles = [];
                const mouse = { x: null, y: null, radius: 100 };
                const resizeCanvas = () => {
                    canvas.width = canvas.parentElement.offsetWidth;
                    canvas.height = canvas.parentElement.offsetHeight;
                };
                canvas.addEventListener('mousemove', e => {
                    const rect = canvas.getBoundingClientRect();
                    mouse.x = e.clientX - rect.left;
                    mouse.y = e.clientY - rect.top;
                });
                canvas.addEventListener('mouseleave', () => { mouse.x = null; mouse.y = null; });
                class Particle {
                    constructor() {
                        this.x = Math.random() * canvas.width;
                        this.y = Math.random() * canvas.height;
                        this.size = Math.random() * 2.5 + 1;
                        this.speedX = (Math.random() * 0.4 - 0.2);
                        this.speedY = (Math.random() * 0.4 - 0.2);
                        this.color = particleColor.replace('{opacity}', `${Math.random() * 0.6 + 0.2}`);
                    }
                    update() {
                        if (mouse.x !== null) {
                            const dx = this.x - mouse.x;
                            const dy = this.y - mouse.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance < mouse.radius) {
                                const forceDirectionX = dx / distance;
                                const forceDirectionY = dy / distance;
                                const force = (mouse.radius - distance) / mouse.radius;
                                this.x += forceDirectionX * force;
                                this.y += forceDirectionY * force;
                            }
                        }
                        this.x += this.speedX;
                        this.y += this.speedY;
                        if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                        if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
                    }
                    draw() {
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                const initParticles = () => {
                    particles = [];
                    let numberOfParticles = (canvas.width * canvas.height) / 12000;
                    for (let i = 0; i < numberOfParticles; i++) particles.push(new Particle());
                };
                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach(p => { p.update(); p.draw(); });
                    requestAnimationFrame(animate);
                };
                window.addEventListener('resize', () => { resizeCanvas(); initParticles(); });
                resizeCanvas();
                initParticles();
                animate();
            },
            setupIntersectionObserver() {
                const observer = new IntersectionObserver((entries, observerInstance) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.remove('hidden-on-load');
                            observerInstance.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                document.querySelectorAll('.hidden-on-load').forEach(el => observer.observe(el));
            },
            numberToWordsPt(num) {
                const units = ["", "um", "dois", "três", "quatro", "cinco", "seis", "sete", "oito", "nove"];
                const teens = ["dez", "onze", "doze", "treze", "catorze", "quinze", "dezesseis", "dezessete", "dezoito", "dezenove"];
                const tens = ["", "dez", "vinte", "trinta", "quarenta", "cinquenta", "sessenta", "setenta", "oitenta", "noventa"];
                const hundreds = ["", "cento", "duzentos", "trezentos", "quatrocentos", "quinhentos", "seiscentos", "setecentos", "oitocentos", "novecentos"];
                if (num === 0) return "zero";
                let words = [];
                const intPart = Math.floor(num);
                function convert(n) {
                    if (n === 0) return "";
                    if (n === 100) return "cem";
                    let tempWords = [];
                    const c = Math.floor(n / 100);
                    const d = Math.floor((n % 100) / 10);
                    const u = n % 10;
                    if (c > 0) tempWords.push(hundreds[c]);
                    if (d >= 2) {
                        tempWords.push(tens[d]);
                        if (u > 0) tempWords.push(`e ${units[u]}`);
                    } else if (d === 1) {
                        tempWords.push(teens[u]);
                    } else if (u > 0) {
                        tempWords.push(units[u]);
                    }
                    return tempWords.join(" ");
                }
                if (intPart > 0) {
                    words.push(convert(intPart));
                    words.push(intPart === 1 ? "real" : "reais");
                }
                const decimalPart = Math.round((num - intPart) * 100);
                if (decimalPart > 0) {
                    words.push("e");
                    words.push(convert(decimalPart));
                    words.push(decimalPart === 1 ? "centavo" : "centavos");
                }
                return words.join(" ").replace(/\s+/g, ' ').trim();
            }
        };

        /**
         * @class FormHandler
         * @description Gerencia as máscaras e validações dos campos do formulário.
         */
        class FormHandler {
            constructor(elements) {
                this.elements = elements;
                this.addEventListeners();
            }
            addEventListeners() {
                this.elements.formInputs.forEach(input => input.addEventListener('input', () => Utils.validateInput(input)));
                this.elements.cpfInput.addEventListener('input', (e) => { e.target.value = Utils.maskCpf(e.target.value); });
                this.elements.zipcodeInput.addEventListener('input', (e) => { e.target.value = Utils.maskCep(e.target.value); });
                this.elements.whatsappInput.addEventListener('input', (e) => { e.target.value = Utils.maskPhone(e.target.value); });
            }
            validateAllInputs() {
                const allValid = this.elements.formInputs.every(input => Utils.validateInput(input));
                if (!allValid) {
                    this.elements.formInputs.find(input => !Utils.validateInput(input))?.focus();
                }
                return allValid;
            }
        }

        /**
         * @class PDFGenerator
         * @description Lida com a geração do contrato em formato PDF.
         */
        class PDFGenerator {
            constructor(state) {
                this.state = state;
                this.jsPDF = jsPDF;
            }

            generateContractPDF() {
                const doc = new this.jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const getVal = (id) => document.getElementById(id).value;
                const pdfData = {
                    fullName: getVal('fullName'),
                    cpf: getVal('cpf'),
                    address: `${getVal('street')}, ${getVal('number')} - ${getVal('neighborhood')}, ${getVal('city')} - ${getVal('state')}, CEP: ${getVal('zipcode')}`,
                    plan: this.state.selectedPlan.plan,
                    valueNumeric: parseFloat(this.state.selectedPlan.value).toFixed(2).replace('.', ','),
                    valueExtensive: Utils.numberToWordsPt(parseFloat(this.state.selectedPlan.value)),
                    loyalty: this.state.loyaltyMode,
                    code: this.state.contractCode,
                    signatureDateExtensive: new Date().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' }),
                    signatureDateShort: new Date().toLocaleDateString('pt-BR'),
                    paymentDay: this.state.paymentDay,
                };

                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                let y = 0;

                const addText = (text, options = {}) => {
                    const { size = 9, style = 'normal', color = "#333333", x = margin, yPos = y, align = 'left', lineHeight = 1.5 } = options;
                    y = yPos;
                    doc.setFontSize(size);
                    doc.setFont('helvetica', style);
                    doc.setTextColor(color);
                    const splitText = doc.splitTextToSize(text, pageWidth - margin * 2);
                    const textHeight = (splitText.length * size * 0.352778) * lineHeight;
                    if (y + textHeight > pageHeight - 20 && text.trim() !== '') {
                        addFooter();
                        doc.addPage();
                        addHeader();
                        y = 35;
                    }
                    doc.text(splitText, x, y, { align: align, lineHeightFactor: lineHeight });
                    y += textHeight + 2;
                };

                const addHeader = () => {
                    doc.setFillColor("#0D161C");
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(18);
                    doc.setTextColor("#DA291C");
                    doc.text("GUARDDRONE", margin, 17);
                };

                const addFooter = () => {
                    const pageNum = doc.internal.getNumberOfPages();
                    doc.setFillColor("#0D161C");
                    doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor("#A0B3C1");
                    doc.text(`Guarddrone Tecnologia em Segurança Ltda. | CNPJ: 52.970.673/0001-78`, margin, pageHeight - 7);
                    doc.text(`Página ${pageNum}`, pageWidth - margin, pageHeight - 7, { align: 'right' });
                };

                addHeader();
                y = 35;
                addText("CONTRATO DE PRESTAÇÃO DE SERVIÇOS DE MONITORAMENTO AÉREO REMOTO", { size: 12, style: 'bold', color: "#117AAC", align: 'center', x: pageWidth / 2, yPos: y });
                y += 5;

                // --- INÍCIO DAS CLÁUSULAS ---
                
                addText("DAS PARTES CONTRATANTES", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`Pelo presente instrumento particular, de um lado:`, { yPos: y });
                addText(`CONTRATADA: GUARDDRONE TECNOLOGIA EM SEGURANÇA LTDA., pessoa jurídica de direito privado, inscrita no CNPJ sob o nº 52.970.673/0001-78, com sede na Rua Curitibanos, n° 1620, Bairro Boa Vista, Canoinhas, SC, CEP 89.460-000.`, { yPos: y });
                addText(`De outro lado:`, { yPos: y });
                addText(`CONTRATANTE: ${pdfData.fullName}, inscrito(a) no CPF sob o n° ${pdfData.cpf}, residente e domiciliado(a) no endereço do imóvel a ser monitorado, qual seja, ${pdfData.address}.`, { yPos: y });
                addText(`As partes acima qualificadas e doravante denominadas, respectivamente, CONTRATADA e CONTRATANTE, têm entre si, justo e contratado o presente instrumento particular de Prestação de Serviços de Monitoramento Aéreo Remoto, que se regerá pelas cláusulas e condições seguintes:`, { yPos: y });
                y += 4;

                addText("CÓDIGO DE IDENTIFICAÇÃO DO CONTRATO", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`Código de Identificação: ${pdfData.code}`, { yPos: y });
                y += 4;

                addText("DO PLANO CONTRATADO", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`Plano de Serviço Selecionado: ${pdfData.plan} Valor Mensal: ${pdfData.valueExtensive} (R$ ${pdfData.valueNumeric}) Modalidade de Contrato: ${pdfData.loyalty}`, { yPos: y });
                y += 4;

                addText("CLÁUSULA PRIMEIRA - DO OBJETO DO CONTRATO", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`1.1. O presente Contrato tem como objeto a prestação de serviços de monitoramento aéreo noturno preventivo e dissuasório, a ser realizado pela CONTRATADA, por meio de Rondas Ostensivas com Drones (Aeronaves Remotamente Pilotadas - RPAs), no perímetro do imóvel da CONTRATANTE, situado no endereço supracitado.`, { yPos: y });
                addText(`1.2. Os serviços descritos no item anterior incluem as seguintes atividades: a) Realização de até 3 (três) sobrevoos programados por noite, em horários variáveis durante o período da madrugada, sobre o imóvel da CONTRATANTE. b) Captura de imagens e/ou vídeos em caso de detecção de atividade atípica ou suspeita nos limites da propriedade monitorada. c) Envio de alertas em tempo real para o(s) número(s) de WhatsApp cadastrado(s) pela CONTRATANTE, contendo a imagem aérea e a geolocalização da ocorrência. d) Possibilidade de acionamento remoto das autoridades policiais competentes, a exclusivo critério da CONTRATADA, caso a análise da ocorrência indique risco iminente ou flagrante delito.`, { yPos: y });
                addText(`1.3. Do Serviço Adicional "Sobrevoo Agora": O serviço "Sobrevoo Agora", que possibilita à CONTRATANTE solicitar um sobrevoo não programado mediante requisição específica via canal de atendimento, constitui um serviço opcional e será cobrado à parte, estando sujeito à disponibilidade operacional da CONTRATADA e às condições climáticas. Este serviço é exclusivo para CONTRATANTES que possuam um contrato de monitoramento ativo com a CONTRATADA. Os valores e condições para a contratação do serviço "Sobrevoo Agora" serão informados separadamente no momento da solicitação.`, { yPos: y });
                addText(`1.4. Fica expressamente estabelecido que o presente serviço possui caráter de meio, e não de resultado. A CONTRATADA empregará a melhor técnica, diligência e recursos disponíveis para a execução do monitoramento, contudo, NÃO SE RESPONSABILIZA E NÃO OFERECE GARANTIA contra a ocorrência de furtos, roubos, invasões, danos ao patrimônio ou quaisquer outros delitos no imóvel da CONTRATANTE.`, { yPos: y });
                y += 4;

                addText("CLÁUSULA SEGUNDA - DAS OBRIGAÇÕES DA CONTRATADA", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`2.1. Prestar os serviços delineados na Cláusula Primeira com o máximo de zelo, profissionalismo e em estrita conformidade com as normas e regulamentações vigentes da Agência Nacional de Aviação Civil (ANAC) e do Departamento de Controle do Espaço Aéreo (DECEA), bem como seguir as melhores práticas internacionais do setor e as diretrizes de sistemas de gestão da qualidade, a exemplo da NBR ISO 9001.`, { yPos: y });
                addText(`2.2. Manter seus equipamentos (drones, baterias, sistemas de comunicação e monitoramento) em perfeitas condições de funcionamento, segurança e aptidão para o uso.`, { yPos: y });
                addText(`2.3. Dispor de pilotos devidamente habilitados, licenciados e treinados para a supervisão e operação das Aeronaves Remotamente Pilotadas (RPAs).`, { yPos: y });
                addText(`2.4. Manter sigilo absoluto sobre todas as informações pessoais da CONTRATANTE e sobre as imagens e dados capturados durante os sobrevoos, utilizando-os estritamente para os fins de segurança e monitoramento previstos neste contrato, e em conformidade com a legislação aplicável.`, { yPos: y });
                addText(`2.5. Comunicar previamente à CONTRATANTE sobre eventuais interrupções programadas do serviço para fins de manutenção, atualizações de sistema ou por qualquer outra necessidade operacional, sempre que possível, com antecedência razoável.`, { yPos: y });
                y += 4;

                addText("CLÁUSULA TERCEIRA - DAS OBRIGAÇÕES DA CONTRATANTE", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`3.1. Efetuar o pagamento pontual do valor mensal estipulado neste contrato, conforme as condições estabelecidas na Cláusula Quinta.`, { yPos: y });
                addText(`3.2. Fornecer e manter atualizados todos os seus dados cadastrais, incluindo, mas não se limitando a, nome completo, CPF, endereço completo, e-mail e, primordialmente, o(s) número(s) de telefone com acesso ao WhatsApp para o recebimento dos alertas. A desatualização desses dados pode comprometer a eficácia do serviço.`, { yPos: y });
                addText(`3.3. Informar prontamente à CONTRATADA sobre quaisquer particularidades, riscos conhecidos, obras ou alterações estruturais relevantes no imóvel que possam, de alguma forma, afetar a segurança, a operacionalidade ou a eficácia dos sobrevoos e do monitoramento.`, { yPos: y });
                addText(`3.4. Utilizar os serviços e as informações recebidas (especialmente os alertas) de forma prudente e responsável, sendo de sua inteira responsabilidade as ações ou omissões tomadas em decorrência de um alerta. A CONTRATADA recomenda expressamente que a CONTRATANTE, ao receber um alerta de situação suspeita, não se exponha a riscos e aguarde a chegada das autoridades competentes, caso estas tenham sido acionadas ou sejam pertinentes.`, { yPos: y });
                y += 4;

                addText("CLÁUSULA QUARTA - DA LIMITAÇÃO DE RESPONSABILIDADE", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`4.1. O serviço de monitoramento poderá ser temporariamente afetado ou interrompido por condições climáticas adversas (tais como chuvas fortes, ventanias, neblina densa), falhas na comunicação do sinal de GPS, problemas de conexão com a operadora de telefonia ou internet, indisponibilidade de energia elétrica no local do imóvel ou por outras condições de caso fortuito ou força maior, alheias ao controle da CONTRATADA. Nestas hipóteses, a CONTRATADA fica isenta de qualquer responsabilidade pela não realização das rondas.`, { yPos: y });
                addText(`4.2. A CONTRATADA não se responsabiliza por eventuais falhas no recebimento dos alertas pela CONTRATANTE que sejam decorrentes de problemas no aparelho celular da CONTRATANTE, ausência de conexão com a internet (Wi-Fi ou dados móveis), aplicativo de mensagens desatualizado, número de telefone incorreto ou qualquer outra questão técnica que seja de responsabilidade exclusiva da CONTRATANTE.`, { yPos: y });
                addText(`4.3. O acionamento das autoridades policiais pela CONTRATADA é um ato discricionário, baseado em sua análise técnica da situação, e visa colaborar com a segurança pública. A CONTRATADA não se responsabiliza pelo tempo de resposta, pela atuação ou pela eventual não atuação das forças policiais, nem pelos resultados de suas intervenções.`, { yPos: y });
                addText(`4.4. A responsabilidade civil da CONTRATADA por eventuais danos diretos comprovadamente causados por falha na prestação do serviço objeto deste contrato fica limitada, em qualquer hipótese, ao valor equivalente a 3 (três) mensalidades vigentes à época do evento danoso.`, { yPos: y });
                y += 4;
                
                addText("CLÁUSULA QUINTA - DO PREÇO E DAS CONDIÇÕES DE PAGAMENTO", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`5.1. Pela prestação dos serviços objeto deste contrato, a CONTRATANTE pagará à CONTRATADA o valor mensal de ${pdfData.valueExtensive} (R$ ${pdfData.valueNumeric}), conforme o plano de serviço selecionado.`, { yPos: y });
                addText(`5.2. O pagamento deverá ser efetuado até o dia ${pdfData.paymentDay} de cada mês, através de boleto bancário, PIX ou outro meio eletrônico de pagamento disponibilizado pela CONTRATADA.`, { yPos: y });
                addText(`5.3. O não pagamento na data de vencimento sujeitará a CONTRATANTE ao pagamento de multa de 2% (dois por cento) sobre o valor devido, acrescido de juros de mora de 1% (um por cento) ao mês e correção monetária pelo Índice Geral de Preços do Mercado (IGPM/FGV) ou outro indice que venha a substituí-lo.`, { yPos: y });
                addText(`5.4. O atraso no pagamento por um período superior a 15 (quinze) dias corridos poderá acarretar a suspensão imediata dos serviços, independentemente de notificação prévia. O atraso superior a 30 (trinta) dias corridos poderá ocasionar o cancelamento do presente contrato por justa causa, sem prejuízo da cobrança dos valores em aberto, da multa por rescisão, se aplicável, e das medidas legais cabíveis.`, { yPos: y });
                y += 4;

                addText("CLÁUSULA SEXTA - DA VIGÊNCIA E DA RESCISÃO", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`6.1. O presente contrato inicia-se na data de sua assinatura, em ${pdfData.signatureDateShort}.`, { yPos: y });
                addText(`6.2. Da Rescisão pela CONTRATADA: A CONTRATADA poderá rescindir o presente contrato a qualquer momento, por sua livre e exclusiva conveniência, mediante comunicação formal à CONTRATANTE com antecedência mínima de 30 (trinta) dias. Nesta hipótese, a CONTRATADA estará isenta de qualquer ônus ou multa rescisória, exceto a obrigação de prestar os serviços até o final do período do aviso prévio, caso a CONTRATANTE já tenha efetuado o pagamento correspondente.`, { yPos: y });
                addText(`6.3. Da Rescisão pela CONTRATANTE:`, { yPos: y });
                const loyaltyTextForPdf = pdfData.loyalty.includes('Com Fidelidade')
                    ? `a) Se a modalidade contratada for "Com Fidelidade" (12 meses), a CONTRATANTE poderá rescindir o contrato antes do término do período de fidelidade, desde que pague multa rescisória não compensatória no valor equivalente a 30% (trinta por cento) das mensalidades restantes para o fim do período contratual. O contrato terá renovação automática por iguais e sucessivos períodos, caso não haja manifestação formal e contrária da CONTRATANTE com 30 (trinta) dias de antecedência do seu término.`
                    : `b) Se a modalidade contratada for "Sem Fidelidade", o contrato terá vigência por prazo indeterminado, podendo a CONTRATANTE rescindir o contrato a qualquer tempo, sem a incidência de qualquer ônus ou multa, mediante aviso prévio por escrito de 30 (trinta) dias.`;
                addText(loyaltyTextForPdf, { yPos: y });
                addText(`6.4. O presente contrato poderá ser rescindido de pleno direito por qualquer uma das partes em caso de descumprimento de qualquer de suas cláusulas ou condições, mediante notificação formal à parte infratora para que sane a falta no prazo improrrogável de até 10 (dez) dias corridos. Persistindo a falha após o referido prazo, o contrato será considerado rescindido, sujeitando a parte culpada às penalidades cabíveis e às indenizações por perdas e danos, conforme o caso.`, { yPos: y });
                y += 4;

                addText("CLÁUSULA SÉTIMA - DA PROTEÇÃO DE DADOS (LGPD)", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`7.1. A CONTRATANTE, ao aceitar os termos deste contrato, AUTORIZA EXPRESSAMENTE a CONTRATADA a realizar sobrevoos e a capturar imagens e vídeos do perímetro de seu imóvel para os fins exclusivos de segurança e monitoramento, conforme detalhado neste instrumento.`, { yPos: y });
                addText(`7.2. A CONTRATADA compromete-se a adotar todas as medidas técnicas e administrativas aptas a proteger os dados pessoais e as imagens coletadas contra acessos não autorizados e de situações acidentais ou ilícitas de destruição, perda, alteração, comunicação ou qualquer forma de tratamento inadequado ou ilícito, nos exatos termos da Lei nº 13.709/2018 (Lei Geral de Proteção de Dados Pessoais - LGPD) e em alinhamento com os padrões da norma NBR ISO/IEC 27001 para segurança da informação.`, { yPos: y });
                addText(`7.3. As imagens capturadas serão armazenadas em ambiente seguro pelo prazo estritamente necessário para o cumprimento das finalidades do contrato ou para o cumprimento de obrigação legal ou regulatória, sendo descartadas de forma segura e irrecoverável após o transcurso deste período.`, { yPos: y });
                y += 4;
                
                addText("CLÁUSULA OITAVA - DO FORO", { size: 10, style: 'bold', color: "#0A1014" });
                addText(`8.1. Para dirimir quaisquer controvérsias, dúvidas ou litígios oriundos do presente contrato, as partes elegem o foro da Comarca de Canoinhas, Estado de Santa Catarina, com expressa renúncia a qualquer outro, por mais privilegiado que seja.`, { yPos: y });
                y += 4;
                
                // --- FIM DAS CLÁUSULAS ---
                
                addText(`E, por estarem assim justas e contratadas, as partes assinam o presente instrumento em 2 (duas) vias de igual teor e forma, na presença das testemunhas abaixo.`, { yPos: y });
                addText(`Canoinhas, ${pdfData.signatureDateExtensive}.`, { yPos: y });
                y += 20;
                addText(`_______________________________________\n${pdfData.fullName}\nCONTRATANTE`, { align: 'center', x: pageWidth / 2, yPos: y });
                y += 20;
                addText(`_______________________________________\nGUARDDRONE TECNOLOGIA EM SEGURANÇA LTDA.\nCONTRATADA`, { align: 'center', x: pageWidth / 2, yPos: y });

                addFooter();
                doc.save(`Contrato_Guarddrone_${pdfData.code}.pdf`);
            }
        }

        /**
         * @class OnboardingApp
         * @description Gerencia o fluxo de onboarding da Guarddrone.
         */
        class OnboardingApp {
            state = { selectedPlan: null, contractCode: null, loyaltyMode: null, paymentDay: '10' };
            elements = {};

            constructor() {
                document.addEventListener('DOMContentLoaded', () => this.init());
            }

            init() {
                this.cacheDOMElements();
                this.initializeModules();
                this.setupFormFlow();
                this.addEventListeners();
            }

            cacheDOMElements() {
                this.elements = {
                    dataCollectionSection: document.getElementById('dataCollectionSection'),
                    contractSection: document.getElementById('contractSection'),
                    confirmationSection: document.getElementById('confirmationSection'),
                    heroCanvas: document.getElementById('hero-canvas'),
                    stepIndicator: document.getElementById('stepIndicator'),
                    onboardingForm: document.getElementById('onboardingForm'),
                    toContractBtn: document.getElementById('toContractBtn'),
                    termsCheckbox: document.getElementById('termsCheckbox'),
                    finalAcceptBtn: document.getElementById('finalAcceptBtn'),
                    downloadPdfBtn: document.getElementById('downloadPdfBtn'),
                    formInputs: Array.from(document.querySelectorAll('#dataCollectionSection .form-input[required]')),
                    fullNameInput: document.getElementById('fullName'),
                    cpfInput: document.getElementById('cpf'),
                    emailInput: document.getElementById('email'),
                    zipcodeInput: document.getElementById('zipcode'),
                    whatsappInput: document.getElementById('whatsapp1'),
                    streetInput: document.getElementById('street'),
                    neighborhoodInput: document.getElementById('neighborhood'),
                    cityInput: document.getElementById('city'),
                    stateInput: document.getElementById('state'),
                    numberInput: document.getElementById('number'),
                    displaySelectedPlan: document.getElementById('display-selected-plan'),
                    hiddenContractCode: document.getElementById('hidden_contract_code'),
                    hiddenSelectedPlan: document.getElementById('hidden_selected_plan'),
                    hiddenMonthlyValue: document.getElementById('hidden_monthly_value'),
                    contractFullName: document.getElementById('contract_fullName'),
                    contractCpf: document.getElementById('contract_cpf'),
                    contractAddress: document.getElementById('contract_address'),
                    contractCodeDisplay: document.getElementById('contract_code_display'),
                    contractPlan: document.getElementById('contract_plan'),
                    contractValueExtensive: document.getElementById('contract_value_extensive'),
                    contractValueNumeric: document.getElementById('contract_value_numeric'),
                    contractValueExtensivePlan: document.getElementById('contract_value_extensive_plan'),
                    contractValueNumericPlan: document.getElementById('contract_value_numeric_plan'),
                    contractPaymentDay: document.getElementById('contract_paymentDay'),
                    contractSignatureDateShort: document.getElementById('contract_signature_date_short'),
                    contractSignatureDateExtensive: document.getElementById('contract_signature_date_extensive'),
                    contractLoyalty: document.getElementById('contract_loyalty'),
                    loyaltyClauseList: document.getElementById('loyaltyClause'),
                    contractSignatureClientName: document.getElementById('contract_signature_client_name'),
                    confirmContractCode: document.getElementById('confirm_contractCode'),
                    confirmFullName: document.getElementById('confirm_fullName'),
                    confirmCpf: document.getElementById('confirm_cpf'),
                    confirmEmail: document.getElementById('confirm_email'),
                    confirmWhatsapp: document.getElementById('confirm_whatsapp'),
                    confirmAddress: document.getElementById('confirm_address'),
                    confirmPlanDetails: document.getElementById('confirm_plan_details'),
                    confirmLoyaltyDetails: document.getElementById('confirm_loyalty_details'),
                    confirmationIconWrapper: document.getElementById('confirmationIconWrapper'),
                    confirmationIcon: document.getElementById('confirmationIcon'),
                    confirmationTitle: document.getElementById('confirmationTitle'),
                    confirmationMessage: document.getElementById('confirmationMessage'),
                    confirmationSummary: document.getElementById('confirmationSummary'),
                    confirmationButtons: document.getElementById('confirmationButtons'),
                    contractText: document.getElementById('contractText'),
                };
            }

            initializeModules() {
                Utils.setupCanvasAnimation(this.elements.heroCanvas);
                Utils.setupIntersectionObserver();
                this.formHandler = new FormHandler(this.elements);
                this.pdfGenerator = new PDFGenerator(this.state);
            }

            addEventListeners() {
                this.elements.zipcodeInput.addEventListener('blur', (e) => this.fetchAddressFromCEP(e));
                this.elements.toContractBtn.addEventListener('click', () => this.handleGoToContract());
                this.elements.termsCheckbox.addEventListener('change', () => { this.elements.finalAcceptBtn.disabled = !this.elements.termsCheckbox.checked; });
                this.elements.onboardingForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
                this.elements.downloadPdfBtn.addEventListener('click', () => this.pdfGenerator.generateContractPDF());
            }

            setupFormFlow() {
                const urlParams = new URLSearchParams(window.location.search);
                this.state.selectedPlan = {
                    plan: urlParams.get('plan') || 'Plano não especificado',
                    value: urlParams.get('value') || '0'
                };
                this.state.loyaltyMode = (this.state.selectedPlan.plan.toLowerCase().includes('anual')) ? 'Com Fidelidade (12 meses)' : 'Sem Fidelidade';
                this.state.contractCode = `GDR-${Date.now()}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                this.elements.displaySelectedPlan.textContent = this.state.selectedPlan.plan;
                this.elements.hiddenSelectedPlan.value = this.state.selectedPlan.plan;
                this.elements.hiddenContractCode.value = this.state.contractCode;
                this.elements.hiddenMonthlyValue.value = `R$ ${parseFloat(this.state.selectedPlan.value).toFixed(2).replace('.', ',')}`;
                this.prefillAddressFields(urlParams);
                this.updateStepIndicator(1);
            }

            prefillAddressFields(urlParams) {
                const fieldsToPrefill = {
                    'cep': this.elements.zipcodeInput, 'street': this.elements.streetInput,
                    'neighborhood': this.elements.neighborhoodInput, 'city': this.elements.cityInput, 'state': this.elements.stateInput
                };
                for (const param in fieldsToPrefill) {
                    const value = urlParams.get(param);
                    if (value) {
                        fieldsToPrefill[param].value = decodeURIComponent(value);
                        Utils.validateInput(fieldsToPrefill[param]);
                    }
                }
            }

            updateStepIndicator(currentStep) {
                this.elements.stepIndicator.querySelectorAll('.step-item').forEach((item, index) => {
                    const circle = item.querySelector('.step-circle');
                    const p = item.querySelector('p');
                    const stepNumber = index + 1;
                    circle.classList.remove('bg-brand-red', 'bg-brand-green', 'bg-gray-700');
                    p.classList.remove('text-brand-red', 'text-brand-green');
                    item.classList.add('opacity-50');
                    if (stepNumber < currentStep) {
                        item.classList.remove('opacity-50');
                        circle.classList.add('bg-brand-green');
                        circle.innerHTML = '&#10003;';
                        p.classList.add('text-brand-green');
                    } else if (stepNumber === currentStep) {
                        item.classList.remove('opacity-50');
                        circle.classList.add('bg-brand-red');
                        p.classList.add('text-brand-red');
                        circle.innerHTML = `${stepNumber}`;
                    } else {
                        circle.classList.add('bg-gray-700');
                        circle.innerHTML = `${stepNumber}`;
                    }
                });
            }

            triggerConfirmationAnimations() {
                const elements = [this.elements.confirmationTitle, this.elements.confirmationMessage, this.elements.confirmationSummary, this.elements.confirmationButtons];
                this.elements.confirmationIcon.classList.add('animate-scale-in');
                this.elements.confirmationIconWrapper.classList.add('confirmation-icon-wrapper');
                elements.forEach((el, i) => {
                    el.classList.add('animate-slide-in');
                    el.style.animationDelay = `${i * 0.2}s`;
                });
                this.triggerConfetti();
            }

            triggerConfetti() {
                const duration = 5 * 1000, animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };
                const interval = setInterval(() => {
                    const timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) return clearInterval(interval);
                    const particleCount = 50 * (timeLeft / duration);
                    confetti({ ...defaults, particleCount, origin: { x: Math.random() * 0.4 + 0.1, y: Math.random() - 0.2 } });
                    confetti({ ...defaults, particleCount, origin: { x: Math.random() * 0.4 + 0.5, y: Math.random() - 0.2 } });
                }, 250);
            }

            async fetchAddressFromCEP(e) {
                const cep = e.target.value.replace(/\D/g, '');
                if (cep.length !== 8) return;
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (!data.erro) {
                        this.elements.streetInput.value = data.logradouro;
                        this.elements.neighborhoodInput.value = data.bairro;
                        this.elements.cityInput.value = data.localidade;
                        this.elements.stateInput.value = data.uf;
                        [this.elements.streetInput, this.elements.neighborhoodInput, this.elements.cityInput, this.elements.stateInput].forEach(input => {
                           input.dispatchEvent(new Event('input', { bubbles: true }));
                        });
                        this.elements.numberInput.focus();
                    }
                } catch (error) { console.error("Erro ao buscar CEP:", error); }
            }

            handleGoToContract() {
                if (this.formHandler.validateAllInputs()) {
                    this.populateContract();
                    this.elements.dataCollectionSection.style.display = 'none';
                    this.elements.contractSection.style.display = 'block';
                    window.scrollTo(0, 0);
                    this.updateStepIndicator(2);
                }
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                if (!this.elements.termsCheckbox.checked) return;
                const form = e.target, button = this.elements.finalAcceptBtn;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Finalizando...';
                try {
                    const response = await fetch(form.action, { method: form.method, body: new FormData(form), headers: { 'Accept': 'application/json' } });
                    if (response.ok) {
                        this.populateConfirmation();
                        this.elements.contractSection.style.display = 'none';
                        this.elements.confirmationSection.style.display = 'block';
                        window.scrollTo(0, 0);
                        this.updateStepIndicator(3);
                        this.triggerConfirmationAnimations();
                    } else { throw new Error('Falha no envio do formulário'); }
                } catch (error) {
                    console.error("Erro no envio do formulário:", error);
                    button.innerHTML = 'Erro ao Enviar. Tente Novamente.';
                    button.style.backgroundColor = 'var(--color-red)';
                    button.disabled = false;
                }
            }

            populateContract() {
                const getVal = (id) => document.getElementById(id).value;
                const numValue = parseFloat(this.state.selectedPlan.value);
                const data = {
                    fullName: getVal('fullName'), cpf: getVal('cpf'),
                    address: `${getVal('street')}, ${getVal('number')} - ${getVal('neighborhood')}, ${getVal('city')} - ${getVal('state')}, CEP: ${getVal('zipcode')}`,
                    formattedValue: numValue.toFixed(2).replace('.', ','), extensiveValue: Utils.numberToWordsPt(numValue),
                    signatureDateExtensive: new Date().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' }),
                    signatureDateShort: new Date().toLocaleDateString('pt-BR')
                };
                this.elements.contractFullName.textContent = data.fullName;
                this.elements.contractCpf.textContent = data.cpf;
                this.elements.contractAddress.textContent = data.address;
                this.elements.contractCodeDisplay.textContent = this.state.contractCode;
                this.elements.contractPlan.textContent = this.state.selectedPlan.plan;
                this.elements.contractValueExtensive.textContent = data.extensiveValue;
                this.elements.contractValueNumeric.textContent = data.formattedValue;
                this.elements.contractValueExtensivePlan.textContent = data.extensiveValue;
                this.elements.contractValueNumericPlan.textContent = data.formattedValue;
                this.elements.contractPaymentDay.textContent = this.state.paymentDay;
                this.elements.contractSignatureDateShort.textContent = data.signatureDateShort;
                this.elements.contractSignatureDateExtensive.textContent = data.signatureDateExtensive;
                this.elements.contractLoyalty.textContent = this.state.loyaltyMode;
                this.elements.contractSignatureClientName.textContent = data.fullName;
                this.elements.loyaltyClauseList.innerHTML = this.state.loyaltyMode.includes('Com Fidelidade')
                    ? `<li>a) Se a modalidade contratada for "Com Fidelidade" (12 meses), a CONTRATANTE poderá rescindir o contrato antes do término do período de fidelidade, desde que pague multa rescisória não compensatória no valor equivalente a 30% (trinta por cento) das mensalidades restantes para o fim do período contratual. O contrato terá renovação automática por iguais e sucessivos períodos, caso não haja manifestação formal e contrária da CONTRATANTE com 30 (trinta) dias de antecedência do seu término.</li>`
                    : `<li>b) Se a modalidade contratada for "Sem Fidelidade", o contrato terá vigência por prazo indeterminado, podendo a CONTRATANTE rescindir o contrato a qualquer tempo, sem a incidência de qualquer ônus ou multa, mediante aviso prévio por escrito de 30 (trinta) dias.</li>`;
            }

            populateConfirmation() {
                const getVal = (id) => document.getElementById(id).value;
                this.elements.confirmContractCode.textContent = this.state.contractCode;
                this.elements.confirmFullName.textContent = getVal('fullName');
                this.elements.confirmCpf.textContent = getVal('cpf');
                this.elements.confirmEmail.textContent = getVal('email');
                this.elements.confirmWhatsapp.textContent = getVal('whatsapp1');
                this.elements.confirmAddress.textContent = `${getVal('street')}, ${getVal('number')}, ${getVal('neighborhood')} - ${getVal('city')}/${getVal('state')} - CEP: ${getVal('zipcode')}`;
                this.elements.confirmPlanDetails.textContent = `${this.state.selectedPlan.plan} - ${this.elements.hiddenMonthlyValue.value}`;
                this.elements.confirmLoyaltyDetails.textContent = this.state.loyaltyMode;
            }
        }

        new OnboardingApp();
    </script>
</body>
</html>
